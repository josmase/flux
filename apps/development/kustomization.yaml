apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Development environment overlay
# Selects lightweight apps from base and applies development-specific patches

resources:
  # Infrastructure
  - persistence/
  
  # Selected lightweight apps from base
  - ../base/immich/
  - ../base/it-tools/
  - ../base/headscale/
  - ../base/cloudflare-ddns/
  
  # Development secret overrides (override base secrets)
  - immich/
  - cloudflare-ddns/

patches:
  # Reduce all deployments to 1 replica for local development
  - patch: |
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
  
  # Reduce all statefulsets to 1 replica
  - patch: |
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: StatefulSet
  
  # Reduce container memory requests for resource-constrained dev environment
  - patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "64Mi"
    target:
      kind: (Deployment|StatefulSet)
  
  # Reduce container CPU requests
  - patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "50m"
    target:
      kind: (Deployment|StatefulSet)
  
  # Reduce container memory limits
  - patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "256Mi"
    target:
      kind: (Deployment|StatefulSet)
  
  # Reduce container CPU limits
  - patch: |
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "500m"
    target:
      kind: (Deployment|StatefulSet)
