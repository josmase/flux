---
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: workload-alerts
spec:
  route:
    receiver: "default"
    groupBy: ["alertname", "cluster", "service", "namespace"]
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 12h
    routes:
      # Route critical alerts to urgent channel
      - receiver: "workload-critical"
        match:
          severity: critical
        groupWait: 10s
        repeatInterval: 1h
        continueRoute: false

      # Route warnings to normal channel
      - receiver: "workload-warnings"
        match:
          severity: warning
        groupWait: 30s
        repeatInterval: 4h
        continueRoute: false

  receivers:
    # Default receiver - Gotify webhook
    - name: "default"
      webhookConfigs:
        - urlSecret:
            name: gotify-alertmanager-urls
            key: default
          sendResolved: true
          httpConfig:
            followRedirects: true

    # Critical workload alerts - Gotify with priority 10
    - name: "workload-critical"
      webhookConfigs:
        - urlSecret:
            name: gotify-alertmanager-urls
            key: critical
          sendResolved: true
          httpConfig:
            followRedirects: true

    # Warning alerts - Gotify with priority 5
    - name: "workload-warnings"
      webhookConfigs:
        - urlSecret:
            name: gotify-alertmanager-urls
            key: warning
          sendResolved: true
          httpConfig:
            followRedirects: true

  inhibitRules:
    # Inhibit warning if critical alert exists for same workload
    - sourceMatch:
        - name: severity
          value: critical
      targetMatch:
        - name: severity
          value: warning
      equal: ["alertname", "namespace", "deployment"]

    # Inhibit pod not ready alerts if deployment replica mismatch exists
    - sourceMatch:
        - name: alertname
          value: DeploymentReplicasMismatch
      targetMatch:
        - name: alertname
          value: PodNotHealthy
      equal: ["namespace", "deployment"]
