apiVersion: v1
kind: ConfigMap
metadata:
  name: jellyfin-rffmpeg-config
data:
  RFFMPEG_HOST: "gpu.local.hejsan.xyz" # Transcode server hostname
  # Init script to fix SSH key permissions
  fix-ssh-permissions.sh: |
    #!/bin/bash
    set -e
    echo "Fixing SSH key permissions..."
    mkdir -p /config/rffmpeg/.ssh
    cp /ssh-keys/* /config/rffmpeg/.ssh/ 2>/dev/null || true
    # Set ownership to abc user (UID 1000)
    chown -R 1000:1000 /config/rffmpeg/.ssh
    chmod 600 /config/rffmpeg/.ssh/* 2>/dev/null || true
    chmod 700 /config/rffmpeg/.ssh
    echo "SSH keys fixed"
  # Startup script to patch rffmpeg and ensure it's ready
  patch-rffmpeg.sh: |
    #!/bin/bash
    # Wait for rffmpeg to be installed by Docker mod (max 30 seconds)
    echo "Waiting for rffmpeg installation..."
    for i in {1..30}; do
      if [ -f /usr/local/bin/rffmpeg ]; then
        echo "rffmpeg found, applying patch..."
        if grep -q 'ssh_command.append("-t")' /usr/local/bin/rffmpeg 2>/dev/null; then
          sed -i '/ssh_command.append("-t")/d' /usr/local/bin/rffmpeg
          echo "Patched rffmpeg: removed -t flag"
        else
          echo "rffmpeg already patched or -t flag not found"
        fi
        exit 0
      fi
      sleep 1
    done
    echo "WARNING: rffmpeg not found after 30 seconds"
    exit 1
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rffmpeg-config
data:
  rffmpeg.yml: |
    ---
    rffmpeg:
        # Logging configuration
        logging:
            log_to_file: true
            logfile: "/config/rffmpeg/rffmpeg.log"
            debug: true

        # Directory configuration
        directories:
            state: "/config/rffmpeg"
            persist: "/dev/shm"
            workdir: "/cache"
            owner: abc
            group: abc

        # Remote (SSH) configuration
        remote:
            user: jellyfin
            workdir: "/mnt/jellyfin-cache"
            args:
                - "-o"
                - "StrictHostKeyChecking=accept-new"
                - "-o"
                - "UserKnownHostsFile=/config/rffmpeg/known_hosts"
                - "-i"
                - "/config/rffmpeg/.ssh/id_rsa"

        # Remote command configuration
        commands:
            # Command prefix (empty - do not use sudo)
            pre:
                - ""
            # The (remote) ffmpeg and ffprobe command binary paths.
            # GPU server uses Jellyfin FFmpeg for full CUDA filter support (tonemap_cuda, etc)
            ffmpeg: "/usr/lib/jellyfin-ffmpeg/ffmpeg"
            ffprobe: "/usr/lib/jellyfin-ffmpeg/ffprobe"
