apiVersion: v1
kind: ConfigMap
metadata:
  name: runner-hooks-kaniko
  namespace: {{ .Values.namespace }}
  labels:
    app: github-runner
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
data:
  k8s-build-job-template.yaml: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      generateName: kaniko-build-
      namespace: {{ .Values.namespace }}
      labels:
        app: kaniko-build
        github-runner-job: "true"
    spec:
      ttlSecondsAfterFinished: {{ .Values.kaniko.jobCleanup }}
      activeDeadlineSeconds: 3600
      backoffLimit: 1
      serviceAccountName: github-runner
      restartPolicy: Never
      
      containers:
      - name: kaniko
        image: {{ .Values.kaniko.image }}
        imagePullPolicy: IfNotPresent
        
        # Kaniko will get its arguments from DOCKERFILE, DESTINATION, etc env vars
        # The GitHub Actions runner passes these from the container spec
        args:
        - "{{ '{{' }} .Dockerfile {{ '}}' }}"
        - "{{ '{{' }} .Context {{ '}}' }}"
        - "{{ '{{' }} .Destination {{ '}}' }}"
        - --cache={{ .Values.kaniko.cache.enabled | ternary "true" "false" }}
        - --cache-repo={{ .CacheRepo }}
        - --cache-ttl={{ .Values.kaniko.cache.ttl }}
        - --log-format=text
        - --verbosity=info
        
        # Mount registry credentials
        volumeMounts:
        - name: docker-config
          mountPath: /kaniko/.docker
          readOnly: true
        - name: workspace
          mountPath: /workspace
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /cache
        
        workingDir: /workspace
        
        resources:
          requests:
            cpu: "{{ .Values.kaniko.resources.requests.cpu }}"
            memory: "{{ .Values.kaniko.resources.requests.memory }}"
          limits:
            cpu: "{{ .Values.kaniko.resources.limits.cpu }}"
            memory: "{{ .Values.kaniko.resources.limits.memory }}"
        
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
          capabilities:
            drop:
            - ALL
      
      volumes:
      - name: docker-config
        secret:
          secretName: {{ .Values.registry.credentialsSecret }}
          items:
          - key: .dockerconfigjson
            path: config.json
          defaultMode: 0400
      - name: workspace
        emptyDir: {}
      - name: tmp
        emptyDir: {}
      - name: cache
        emptyDir: {}
      
      securityContext:
        fsGroup: 65534
        runAsNonRoot: true
        runAsUser: 65534
      
      securityContext:
        fsGroup: 65534
        runAsNonRoot: true
        runAsUser: 65534
