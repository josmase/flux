# GitHub Actions Runner Controller (ARC) Setup with Kaniko
# This chart sets up RBAC, ConfigMaps, and runner pod templates for ARC with Kaniko-based builds

# Runner namespace
namespace: arc-runners

# Create shared resources (RBAC, ConfigMaps)
# Only one HelmRelease should have this set to true
createSharedResources: true

# Runner scale set configuration
runnerScaleSet:
  # Name of the runner scale set (will be used for scaling)
  name: "app-runner"

  # GitHub configuration
  github:
    # Repository or organization URL
    configUrl: "https://github.com/josmase/app"
    # Secret name containing GitHub token (must exist in namespace)
    configSecret: "controller-manager"

  # Scaling configuration
  minRunners: 1
  maxRunners: 3

  # Runner image configuration
  image:
    # Runner image (GitHub Actions official runner)
    repository: "artifactory.local.hejsan.xyz/docker/actions/runner-kaniko"
    tag: "2.330.0-8@sha256:fdb31055bd5399ce0f3cd621a01a710c9317ba65d891e83e981760d249b5bde7"
    pullPolicy: Always

  # Storage configuration for work directory
  storage:
    className: "openebs-hostpath"
    size: "2Gi"

  # Security context for runner pods
  securityContext:
    runAsNonRoot: true
    runAsUser: 1001
    fsGroup: 123
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false

  # Resource limits for runner pods
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "2"
      memory: "2Gi"

# Kaniko build job configuration
kaniko:
  # Kaniko executor image
  image: "gcr.io/kaniko-project/executor:v1.24.0@sha256:4e7a52dd1f14872430652bb3b027405b8dfd17c4538751c620ac005741ef9698"

  # Resource limits for Kaniko build jobs
  resources:
    requests:
      cpu: "500m"
      memory: "512Mi"
    limits:
      cpu: "2"
      memory: "2Gi"

  # Cache configuration
  cache:
    enabled: true
    ttl: "24h"

  # Job cleanup (ttlSecondsAfterFinished)
  jobCleanup: 300

# Registry credentials secret
registry:
  # Secret name containing .dockerconfigjson
  credentialsSecret: "registry-credentials"
