{{- if .Values.githubRunner.enabled }}
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gha-runner-scale-set-{{ .Values.appName }}
  namespace: {{ .Values.githubRunner.namespace }}
  labels:
    app: {{ .Values.appName }}
spec:
  chartRef:
    kind: OCIRepository
    name: gha-runner-scale-set
    namespace: flux-system
  interval: 5m
  values:
    runnerScaleSetName: {{ .Values.appName }}
    githubConfigUrl: {{ .Values.githubRunner.githubConfigUrl }}
    githubConfigSecret: {{ .Values.githubRunner.githubConfigSecret }}
    minRunners: {{ .Values.githubRunner.minRunners }}
    maxRunners: {{ .Values.githubRunner.maxRunners }}
    containerMode:
      type: "kubernetes"
    kubernetesModeWorkVolumeClaim:
      accessModes: ["ReadWriteOnce"]
      storageClassName: {{ .Values.githubRunner.storageClassName }}
      resources:
        requests:
          storage: {{ .Values.githubRunner.storageSize }}
    template:
      spec:
        securityContext:
          fsGroup: 123
        containers:
          - name: runner
            image: {{ .Values.githubRunner.image }}
            command: ["/home/runner/run.sh"]
            securityContext:
              capabilities:
                add:
                  - SETUID
                  - SETGID
            env:
              - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
                value: "false"
              - name: _BUILDAH_STARTED_IN_USERNS
                value: ""
              - name: BUILDAH_ISOLATION
                value: "chroot"
              - name: STORAGE_DRIVER
                value: "vfs"
        volumes:
          - name: work
            ephemeral:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  storageClassName: {{ .Values.githubRunner.storageClassName }}
                  resources:
                    requests:
                      storage: {{ .Values.githubRunner.storageSize }}
{{- end }}
